<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- Latest compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <!-- jQuery library -->
    <script src="asset/js/jquery-3.6.4.min.js"></script>
    <script src="asset/js/sockjs.min.js"></script>
    <script src="asset/js/stomp.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- Image and text -->
      <nav id="navbar" class="navbar navbar-light bg-light">
        <a id="navbar-container" class="navbar-brand" href="#">
          <img
            id="navbar-image"
            src="/docs/4.0/assets/brand/bootstrap-solid.svg"
            width="30"
            height="30"
            class="d-inline-block align-top"
            alt=""
          />
          Bootstrap
        </a>
      </nav>
      <div style="display: flex">
        <ul class="list-group" id="list-friend" style="width: 300px">
          <li class="list-group-item" id="2145e6e7-1776-43df-8d0a-d6b8165c6270">
            An item
          </li>
          <!-- <li class="list-group-item">A second item</li>
          <li class="list-group-item">A third item</li>
          <li class="list-group-item">A fourth item</li>
          <li class="list-group-item">And a fifth one</li> -->
        </ul>
        <div class="" style="flex: 1"></div>
      </div>
      <form
        id="loginForm"
        style="
          width: 200px;
          margin: 10px;
          padding: 10px;
          border-radius: 4px;
          border: 1px solid black;
        "
        action="javascript:void(0);"
      >
        <div class="mb-3">
          <label class="form-label" for="username">username</label>
          <input class="form-control" type="text" id="email" />
        </div>
        <div class="mb-3">
          <label class="form-label" for="password">password</label>
          <input class="form-control" type="password" id="password" />
        </div>
        <br />
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
  </body>
  <script>
    var username;
    var image;
    var topicId;
    var stompClient = null;
    $(document).ready(function () {
      $(".list-group-item").click(function () {
        console.log("vo");
        var token = localStorage.getItem("accessToken");
        var topicContactId = this.id;
        stompClient.connect(
          { Authorization: token, userId: userId },
          function (frame) {
            console.log("Connected: " + frame);
          }
        );
        stompClient.subscribe(
          "/ws/topic/chat/" + topicContactId,
          function (chat) {
            loadChat(chat);
          }
        );
      });
      $("#navbar").hide();
      var loginForm = $("#loginForm");

      loginForm.submit(() => {
        var email = $("#email").val();
        var password = $("#password").val();
        var loginDto = new Object();
        loginDto.email = email;
        loginDto.password = password;
        loginDto.confirmpassword = password;
        $.ajax({
          url: "http://localhost:8080/auth/login",
          method: "POST",
          crossDomain: true,
          dataType: "json",
          data: JSON.stringify({
            email,
            password,
            confirmpassword: password,
          }),
          contentType: "application/json",
          success: function (result, status, jqXHR) {
            setuplogin(result);
          },
          error(jqXHR, textStatus, errorThrown) {},
        });
      });

      async function setuplogin(data) {
        localStorage.setItem("accessToken", data.data.accessToken);
        loginForm.hide();
        await $.ajax({
          url: "http://localhost:8080/auth/getUserInfoByToken",
          method: "POST",
          crossDomain: true,
          dataType: "json",
          headers: {
            Authorization: data.data.accessToken,
          },
          contentType: "application/json",
          success: function (result, status, jqXHR) {
            username = result.data.name;
            image = result.data.imageUrl;
            topicId = result.data.topicId;
            userId = result.data.id;

            connect();
            loadNavbar(username, image);
          },
          error(jqXHR, textStatus, errorThrown) {},
        });
      }

      function loadNavbar(username, image) {
        $("#navbar").show();
        $("#navbar-container").text(username);
        $("#navbar-image").attr("src", image);
        loadFriendUser();
      }

      async function loadFriendUser() {
        var token = localStorage.getItem("accessToken");
        var friendList;
        var html = "";
        await $.ajax({
          url: "http://localhost:8080/users/internal/contact/getListFriend",
          method: "POST",
          crossDomain: true,
          dataType: "json",
          headers: {
            Authorization: token,
          },
          contentType: "application/json",
          success: function (result, status, jqXHR) {
            friendList = result.data["2"];
          },
          error(jqXHR, textStatus, errorThrown) {},
        });
        console.log(friendList);
        friendList.forEach((element) => {
          html += ` <li class="list-group-item" id="${element.topicContactId}">${element.userFriend.name}</li> `;
        });

        $("#list-friend").append(html);
      }
    });

    function connect() {
      var token = localStorage.getItem("accessToken");
      var socket = new SockJS("http://localhost:8081/system/ws");
      stompClient = Stomp.over(socket);
      stompClient.connect(
        { Authorization: token, userId: userId },
        function (frame) {
          console.log("Connected: " + frame);
        }
      );
    }
  </script>
  <!-- "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" --profile-directory="Profile 22" --disable-web-security --disable-gpu --user-data-dir="D:\chromeTemp" -->
</html>
